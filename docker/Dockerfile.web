FROM node:22-alpine AS builder

WORKDIR /app

# Copy root package files
COPY package.json nx.json tsconfig.base.json ./

# Copy packages
COPY packages/ ./packages/

# Copy web app
COPY apps/web/ ./apps/web/

# Install dependencies without lock file so npm resolves platform-specific
# optional deps (e.g. @rollup/rollup-linux-x64-musl) for Alpine/musl
RUN npm install --legacy-peer-deps

# Build
RUN npx nx run web:build

# Runtime - serve with nginx
FROM nginx:alpine

COPY docker/nginx.conf.template /etc/nginx/templates/default.conf.template
COPY --from=builder /app/apps/web/dist /usr/share/nginx/html

ENV API_URL=http://api:8080
ENV NGINX_ENVSUBST_FILTER=API_URL

EXPOSE 80
