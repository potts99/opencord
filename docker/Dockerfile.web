FROM node:22-alpine AS builder

WORKDIR /app

# Copy root package files
COPY package.json package-lock.json* ./
COPY nx.json tsconfig.base.json ./

# Copy packages
COPY packages/ ./packages/

# Copy web app
COPY apps/web/ ./apps/web/

# Install dependencies
RUN npm install --legacy-peer-deps

# Ensure Rollup native bindings are installed for Alpine/musl
RUN npm rebuild rollup

# Build
RUN npx nx run web:build

# Runtime - serve with nginx
FROM nginx:alpine

COPY docker/nginx.conf.template /etc/nginx/templates/default.conf.template
COPY --from=builder /app/apps/web/dist /usr/share/nginx/html

ENV API_URL=http://api:8080
ENV NGINX_ENVSUBST_FILTER=API_URL

EXPOSE 80
